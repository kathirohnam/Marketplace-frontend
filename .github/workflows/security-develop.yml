name: Frontend Security (develop)

on:
  push:
    branches: [develop]
    paths:
      - "src/**"
      - "angular.json"
      - "package*.json"
      - "**/*.ts"
      - "**/*.js"
  pull_request:
    branches: [develop]
    paths:
      - "src/**"
      - "angular.json"
      - "package*.json"
      - "**/*.ts"
      - "**/*.js"
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write
  id-token: none

jobs:
  codeql:
    name: CodeQL (JS/TS)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - uses: github/codeql-action/analyze@v3
        with:
          # Write SARIF locally instead of uploading to Code Scanning
          output: sarif-results
          upload: false
      - name: Upload CodeQL SARIF
        uses: actions/upload-artifact@v4
        with:
          name: codeql-sarif
          path: sarif-results/**/*.sarif
          if-no-files-found: ignore

  semgrep:
    name: Semgrep (JS/OWASP)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Install Semgrep CLI
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install semgrep
      - name: Run Semgrep (emit SARIF)
        run: |
          semgrep --version
          semgrep scan \
            --config p/javascript \
            --config p/owasp-top-ten \
            --sarif --output semgrep.sarif || true
          # ensure file exists
          [ -f semgrep.sarif ] || echo '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"semgrep"}},"results":[]}]}'> semgrep.sarif
      - name: Upload Semgrep SARIF
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: semgrep.sarif
          if-no-files-found: warn

  eslint:
    name: ESLint (TS only)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Run ESLint and export SARIF
        shell: bash
        run: |
          echo '{ "env": { "browser": true, "es2021": true }, "parser": "@typescript-eslint/parser", "plugins": ["@typescript-eslint"], "extends": ["eslint:recommended"] }' > tmp.eslintrc.json
          npx -y -p eslint@8 -p @typescript-eslint/parser@6 -p @typescript-eslint/eslint-plugin@6 \
            eslint "src/**/*.ts" \
            --config tmp.eslintrc.json --max-warnings=0 \
            -f sarif -o eslint.sarif || true
          [ -f eslint.sarif ] || echo '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"eslint"}},"results":[]}]}'> eslint.sarif
      - uses: actions/upload-artifact@v4
        with:
          name: eslint-sarif
          path: eslint.sarif
          if-no-files-found: warn

  deps:
    name: Dependency checks (npm audit + Retire.js)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: npm audit (prod, high+ only)
        run: |
          npm audit --production --audit-level=high --json > npm-audit.json || true
      - name: Retire.js (scan src only)
        run: |
          npx --yes retire@3 --js --path src \
            --severity high --outputformat json --outputpath retire.json --exitwith 0 || true
      - uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            npm-audit.json
            retire.json
          if-no-files-found: warn

  secrets:
    name: Secret leaks (Gitleaks)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Run Gitleaks via Docker (emit SARIF)
        run: |
          docker run --rm -v "$PWD":/repo zricethezav/gitleaks:latest detect \
            --source=/repo --no-git \
            --report-format sarif --report-path /repo/gitleaks.sarif || true
          [ -f gitleaks.sarif ] || echo '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"gitleaks"}},"results":[]}]}'> gitleaks.sarif
      - uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results.sarif
          path: gitleaks.sarif
          if-no-files-found: warn

  summary:
    name: Job summaries
    runs-on: ubuntu-latest
    needs: [codeql, semgrep, eslint, deps, secrets]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Ensure jq is present
        run: |
          jq --version || (sudo apt-get update && sudo apt-get install -y jq)
      - name: Write summary
        shell: bash
        run: |
          echo "## Security scan summary" >> "$GITHUB_STEP_SUMMARY"

          find_first_sarif () {
            dir="$1"
            file=$(find "$dir" -type f -name '*.sarif' | head -n1)
            echo "$file"
          }

          summarize_sarif () {
            label="$1"; dir="$2"
            file=$(find_first_sarif "$dir")
            if [ -n "$file" ] && [ -f "$file" ]; then
              count=$(jq -r '([.runs[].results? | length] | add) // 0' "$file")
              echo "### $label" >> "$GITHUB_STEP_SUMMARY"
              echo "Findings: $count" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "### $label" >> "$GITHUB_STEP_SUMMARY"
              echo "No SARIF produced" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
          }

          summarize_json () {
            label="$1"; file="$2"; jqexpr="$3"
            if [ -f "$file" ]; then
              count=$(jq -r "$jqexpr" "$file")
              echo "### $label" >> "$GITHUB_STEP_SUMMARY"
              echo "Findings: $count" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "### $label" >> "$GITHUB_STEP_SUMMARY"
              echo "No report found" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
          }

          summarize_sarif "CodeQL" "artifacts/codeql-sarif"
          summarize_sarif "Semgrep" "artifacts/semgrep-sarif"
          summarize_sarif "ESLint"  "artifacts/eslint-sarif"
          summarize_sarif "Gitleaks" "artifacts/gitleaks-results.sarif"

          summarize_json "Retire.js" "artifacts/dependency-reports/retire.json" '([.data[]?.results? | length] | add) // 0'

          if [ -f "artifacts/dependency-reports/npm-audit.json" ]; then
            highs=$(jq -r '.metadata.vulnerabilities.high // 0' artifacts/dependency-reports/npm-audit.json)
            crits=$(jq -r '.metadata.vulnerabilities.critical // 0' artifacts/dependency-reports/npm-audit.json)
            echo "### npm audit" >> "$GITHUB_STEP_SUMMARY"
            echo "High: $highs Critical: $crits" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### npm audit" >> "$GITHUB_STEP_SUMMARY"
            echo "No report found" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi
